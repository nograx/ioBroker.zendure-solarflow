{
  "version": 3,
  "sources": ["../../../src/models/deviceModels/Sf2400Ac.ts"],
  "sourcesContent": ["import { ac2400ControlStates } from \"../../constants/ac2400ControlStates\";\nimport { ac2400States } from \"../../constants/ac2400States\";\nimport { ZendureSolarflow } from \"../../main\";\nimport { IHemsEpPayload } from \"../IDeviceAutomationPayload\";\nimport { IZenHaDeviceDetails } from \"../IZenHaDeviceDetails\";\nimport { ZenHaDevice } from \"./ZenHaDevice\";\n\nexport class Sf2400Ac extends ZenHaDevice {\n  maxInputLimit = 2400;\n  maxOutputLimit = 2400;\n\n  states = ac2400States;\n  controlStates = ac2400ControlStates;\n\n  public constructor(\n    _adapter: ZendureSolarflow,\n    _productKey: string,\n    _deviceKey: string,\n    _productName: string,\n    _deviceName: string,\n    _zenHaDeviceDetails?: IZenHaDeviceDetails\n  ) {\n    super(\n      _adapter,\n      _productKey,\n      _deviceKey,\n      _productName,\n      _deviceName,\n      _zenHaDeviceDetails\n    );\n  }\n\n  public async setAcMode(acMode: number): Promise<void> {\n    if (this.adapter.mqttClient && this.productKey && this.deviceKey) {\n      if (acMode >= 0 && acMode <= 3) {\n        const setAcMode = { properties: { acMode: acMode } };\n        this.adapter.log.debug(`[setAcMode] Set AC mode to ${acMode}!`);\n        this.adapter.mqttClient?.publish(\n          this.iotTopic,\n          JSON.stringify(setAcMode)\n        );\n\n        // Check if device is HUB, then check if smartMode is false - if so send a warning to log!\n        const smartMode = await this.adapter.getStateAsync(\n          this.productKey + \".\" + this.deviceKey + \".control.smartMode\"\n        );\n\n        if (smartMode && !smartMode.val) {\n          this.adapter.log.warn(\n            `[setAcMode] AC mode was switched and smartMode is false - changes will be written to flash memory. In the worst case, the device may break or changes may no longer be saved!`\n          );\n        }\n      } else {\n        this.adapter.log.error(\n          `[setAcMode] AC mode must be a value between 0 and 3!`\n        );\n      }\n    }\n  }\n\n  public setAcSwitch(acSwitch: boolean): void {\n    if (this.adapter.mqttClient && this.productKey && this.deviceKey) {\n      const setAcSwitchContent = {\n        properties: { acSwitch: acSwitch ? 1 : 0 },\n      };\n      this.adapter.log.debug(\n        `[setAcSwitch] Set AC Switch for device ${this.deviceKey} to ${acSwitch}!`\n      );\n      this.adapter.mqttClient?.publish(\n        this.iotTopic,\n        JSON.stringify(setAcSwitchContent)\n      );\n    }\n  }\n\n  public async setDeviceAutomationInOutLimit(\n    limit: number // can be negative, negative will trigger charging mode\n  ): Promise<void> {\n    if (this.adapter.mqttClient && this.productKey && this.deviceKey) {\n      this.adapter.log.debug(\n        `[setDeviceAutomationInOutLimit] Set device Automation limit to ${limit}!`\n      );\n\n      if (limit) {\n        limit = Math.round(limit);\n      } else {\n        limit = 0;\n      }\n\n      if (this.adapter.config.useLowVoltageBlock) {\n        const lowVoltageBlockState = await this.adapter.getStateAsync(\n          this.productKey + \".\" + this.deviceKey + \".control.lowVoltageBlock\"\n        );\n        if (\n          lowVoltageBlockState &&\n          lowVoltageBlockState.val &&\n          lowVoltageBlockState.val == true &&\n          limit > 0\n        ) {\n          limit = 0;\n        }\n\n        const fullChargeNeeded = await this.adapter.getStateAsync(\n          this.productKey + \".\" + this.deviceKey + \".control.fullChargeNeeded\"\n        );\n\n        if (\n          fullChargeNeeded &&\n          fullChargeNeeded.val &&\n          fullChargeNeeded.val == true &&\n          limit > 0\n        ) {\n          limit = 0;\n        }\n      }\n\n      // Convert maxInputLimit to negative value and compare to limit\n      if (limit < 0 && limit < -this.maxInputLimit) {\n        this.adapter.log.debug(\n          `[setDeviceAutomationInOutLimit] limit ${limit} is below the maximum input limit of ${this.maxInputLimit}, setting to ${-this.maxInputLimit}!`\n        );\n        limit = -this.maxInputLimit;\n      } else if (limit > this.maxOutputLimit) {\n        this.adapter.log.debug(\n          `[setDeviceAutomationInOutLimit] limit ${limit} is higher the maximum output limit of ${this.maxOutputLimit}, setting to ${this.maxOutputLimit}!`\n        );\n        limit = this.maxOutputLimit;\n      }\n\n      this.messageId += 1;\n\n      const timestamp = new Date();\n      timestamp.setMilliseconds(0);\n\n      // Device Automation for Solarflow 2400 AC and Solarflow 800\n      this.adapter.log.debug(\n        `[setDeviceAutomationInOutLimit] Using HEMS Variant of device automation, as deviceKey '${this.deviceKey}' detected!`\n      );\n\n      // HEMS Variante\n      const _arguments: IHemsEpPayload = {\n        outputPower: limit > 0 ? limit : 0,\n        chargeState: limit > 0 ? 0 : 1,\n        chargePower: limit > 0 ? 0 : limit,\n        mode: 9,\n      };\n\n      const hemsEP = {\n        arguments: _arguments,\n        function: \"hemsEP\",\n        messageId: this.messageId,\n        deviceKey: this.deviceKey,\n        timestamp: timestamp.getTime() / 1000,\n      };\n      this.adapter.mqttClient?.publish(\n        this.functionTopic,\n        JSON.stringify(hemsEP)\n      );\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
